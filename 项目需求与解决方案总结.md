# 邮箱监控系统项目需求与解决方案总结

## 📋 项目背景
用户需要实时监控特定域名邮件，并自动处理解析为可读格式。

---

## 🎯 核心需求

### 1. 邮件监控需求
- **目标域名**: 专门监控 `shiep.edu.kg` 域名的邮件
- **实时性要求**: 6秒间隔检查新邮件
- **监控范围**: 只处理启动后收到的新邮件，不处理历史邮件
- **稳定性**: 需要7x24小时持续运行，网络中断自动重连

### 2. 性能要求
- **高并发处理**: 能处理大量邮件场景（如10封邮件/10秒）
- **响应速度**: 快速检测和处理，不能阻塞监控主流程
- **资源优化**: 避免重复处理，内存和CPU使用合理

### 3. 邮件处理需求
- **完整保存**: 保存原始EML文件
- **内容解析**: 提取邮件头部、正文、附件信息
- **格式转换**: 生成HTML显示文件便于查看
- **数据准备**: 输出JSON格式数据供前端使用

### 4. 前端界面需求
- **用户认证系统**: 注册/登录邮箱界面，支持用户身份验证
- **权限分级管理**: 
  - 所有用户都可以创建指定域名下的邮件
  - 普通用户：只能查看自己相关的往来邮件
  - 管理员用户：可以查看所有用户与外界的往来邮件
- **用户信息管理**: 支持账号/密码/VIP状态/账号余额等信息
- **多域名支持**: 支持管理多个域名，不仅限于shiep.edu.kg

### 5. 数据存储需求
- **用户数据表**: 存储用户与管理员信息（账号/密码/VIP状态/余额）
- **域名管理表**: 存储域名信息和该域名下的邮箱便于后续添加域名与管理/查看域名邮箱
- **邮件数据表**: 存储邮件元信息（发件人/收件人/主题/时间等）
- **附件存储策略**: 
  - 附件大小限制：最大100MB
  - 大附件（>100MB）：保留1天后自动清理
  - 小附件（≤100MB）：保留1周后清理
  - 数据库存储文件路径，实际文件本地存储

### 6. 技术架构需求
- **无隧道依赖**: 避免使用不稳定的ngrok、cloudflared等隧道工具，直接使用QQ邮箱IMAP协议来实现邮件监控
- **简单可靠**: 采用成熟稳定的技术方案
- **易部署**: 支持Windows和Linux环境
- **可扩展**: 支持后续功能扩展
- **数据库集成**: MySQL数据库存储用户和邮件元信息

---

## 💡 解决方案演进

### 第一阶段：隧道方案（已废弃）
**尝试方案**: Cloudflare Worker + ngrok/cloudflared隧道
**问题**: 隧道频繁断线，连接不稳定，用户体验差
**结果**: 放弃隧道方案

### 第二阶段：QQ邮箱直连方案（成功）
**采用方案**: QQ邮箱IMAP直接监控
**优势**: 稳定可靠，无需额外依赖，成熟技术
**结果**: 基础功能实现成功

### 第三阶段：性能优化方案（当前）
**升级重点**: 异步队列处理架构
**解决问题**: 高并发邮件处理，避免阻塞
**技术特点**: 主监控线程 + 工作线程池

---

## ✅ 当前已实现的解决方案

### 🏗️ 系统架构
```
主监控线程 (6秒循环)
    ↓ 检测新邮件
    ↓ 域名过滤 (shiep.edu.kg)
    ↓ 快速入队
异步处理队列
    ↓ 多工作线程并行处理
    ↓ 邮件解析 + HTML生成
结果输出 (EML + HTML + JSON)
```

### 🔧 核心组件

#### 1. RealtimeEmailMonitor 类
- **连接管理**: QQ邮箱IMAP连接，自动重试机制
- **增量检查**: 只检查启动后的新邮件，避免重复处理
- **域名过滤**: 精准识别 shiep.edu.kg 域名邮件
- **异步队列**: 主线程快速检测，工作线程并行处理

#### 2. EmailParser 类
- **EML解析**: 完整解析邮件内容和结构
- **内容提取**: 支持HTML和纯文本邮件
- **附件处理**: 识别和处理各类附件
- **HTML生成**: 生成美观的邮件显示页面

#### 3. 异步处理机制
- **Queue队列**: 线程安全的邮件处理队列
- **工作线程池**: 4个工作线程并行处理邮件
- **状态统计**: 实时统计处理进度和成功率
- **故障恢复**: 工作线程异常自动重启

### 📁 文件结构
```
cloudfare-qq-mail/
├── realtime_monitor.py      # 主监控程序
├── email_parser.py          # 邮件解析器
├── email_config.py          # 配置管理
├── received_emails/         # 邮件存储目录
│   ├── *.eml               # 原始邮件文件
│   └── *_display.html      # HTML显示文件
└── frontend_queue/          # 前端数据队列
    └── *.json              # 前端数据文件
```

### 🚀 运行特性
- **启动即用**: `python realtime_monitor.py` 一键启动
- **自动恢复**: 网络中断自动重连，无需人工干预
- **实时反馈**: 控制台显示详细运行状态和统计信息
- **高性能**: 支持高并发邮件处理，不阻塞监控
- **跨平台**: 支持Windows和Linux环境

### 📊 性能表现
- **检测延迟**: 最大6秒延迟检测新邮件
- **处理并发**: 4线程并行，支持突发大量邮件
- **成功率**: 近100%处理成功率
- **稳定性**: 7x24小时持续运行，自动故障恢复

---

## 🔮 扩展计划

### 前端Web界面开发
- **用户认证系统**: 注册登录功能实现
- **权限管理**: 普通用户与管理员权限分离
- **邮件查看界面**: 基于权限的邮件展示
- **用户管理**: VIP状态、余额管理等功能

### 数据库集成
- **MySQL数据库**: 用户信息、邮件元数据存储
- **附件管理策略**: 分级存储和自动清理机制
- **多域名支持**: 扩展支持更多邮件域名

### Linux部署支持
- **服务化**: systemd服务配置
- **自动启动**: 开机自启动设置
- **日志管理**: 日志轮转和监控

### Docker容器化
- **环境隔离**: 完整的运行环境打包
- **部署简化**: 一键部署到任意环境
- **版本管理**: 镜像版本控制和回滚

---

## 💡 技术特点总结
1. **稳定可靠**: 放弃不稳定的隧道方案，采用成熟的IMAP协议
2. **高性能**: 异步队列架构，支持高并发处理
3. **智能过滤**: 精准的域名和时间过滤，避免无效处理
4. **完整功能**: EML保存、内容解析、HTML展示、JSON数据一站式处理
5. **易维护**: 清晰的模块划分，详细的日志输出，便于调试和维护
6. **权限管控**: 用户分级管理，普通用户与管理员权限分离
7. **存储优化**: 附件分级存储策略，大文件自动清理机制
8. **多域名扩展**: 支持管理多个邮件域名，便于业务扩展

---

## 🎯 当前状态
✅ **核心功能完成**: 邮件监控、解析、处理全流程实现
✅ **性能优化完成**: 异步队列处理，支持高并发
✅ **稳定性验证**: 实际运行测试通过，自动故障恢复
🔄 **持续运行中**: 系统正在后台稳定运行，等待处理新邮件
📋 **下一阶段**: 前端界面开发、数据库集成、用户权限管理

**当前阶段：核心监控系统已达到生产可用状态，正准备进入前端开发和数据库集成阶段。**
