#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
é‚®ä»¶ç³»ç»Ÿç®€å•å¯åŠ¨ç¨‹åº
åŠŸèƒ½ï¼šå¿«é€Ÿå¯åŠ¨é‚®ä»¶å¤„ç†ç³»ç»Ÿçš„ä¸»è¦ç»„ä»¶
ä½œè€…ï¼šç³»ç»Ÿç®¡ç†å‘˜
ç‰ˆæœ¬ï¼š1.0
"""

import os
import sys
import time
import subprocess
from datetime import datetime

def æ‰“å°æ ‡é¢˜():
    """æ‰“å°ç³»ç»Ÿå¯åŠ¨æ ‡é¢˜"""
    print("=" * 60)
    print("ğŸ“§ é‚®ä»¶å¤„ç†ç³»ç»Ÿ - ç®€å•å¯åŠ¨å™¨")
    print("=" * 60)
    print(f"ğŸ• å¯åŠ¨æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ“ å·¥ä½œç›®å½•: {os.getcwd()}")
    print("=" * 60)

def æ£€æŸ¥ä¾èµ–():
    """æ£€æŸ¥ç³»ç»Ÿä¾èµ–"""
    print("ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–...")
    
    # æ£€æŸ¥Pythonç‰ˆæœ¬
    if sys.version_info < (3, 7):
        print("âŒ Pythonç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦3.7æˆ–æ›´é«˜ç‰ˆæœ¬")
        return False
    
    # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
    å¿…éœ€æ–‡ä»¶ = [
        "email_config.py",
        "database/db_manager.py", 
        "frontend/templates/index.html"
    ]
    
    for æ–‡ä»¶ in å¿…éœ€æ–‡ä»¶:
        if not os.path.exists(æ–‡ä»¶):
            print(f"âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: {æ–‡ä»¶}")
            return False
    
    print("âœ… ç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ")
    return True

def å¯åŠ¨ç»„ä»¶(ç»„ä»¶å, ç¨‹åºæ–‡ä»¶):
    """å¯åŠ¨å•ä¸ªç»„ä»¶"""
    try:
        print(f"ğŸš€ å¯åŠ¨ {ç»„ä»¶å}...")
        
        # åœ¨Windowsä¸Šä½¿ç”¨startå‘½ä»¤å¯åŠ¨æ–°çª—å£
        if os.name == 'nt':
            cmd = f'start "é‚®ä»¶ç³»ç»Ÿ - {ç»„ä»¶å}" python "{ç¨‹åºæ–‡ä»¶}"'
            subprocess.run(cmd, shell=True)
        else:
            # åœ¨Linux/Macä¸Šä½¿ç”¨åå°è¿è¡Œ
            cmd = f'python3 "{ç¨‹åºæ–‡ä»¶}" &'
            subprocess.run(cmd, shell=True)
        
        print(f"âœ… {ç»„ä»¶å} å¯åŠ¨æˆåŠŸ")
        return True
        
    except Exception as e:
        print(f"âŒ å¯åŠ¨ {ç»„ä»¶å} æ—¶å‡ºé”™: {e}")
        return False

def æ£€æŸ¥ç«¯å£(ç«¯å£):
    """æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"""
    if ç«¯å£ is None:
        return True
        
    try:
        import socket
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        result = sock.connect_ex(('127.0.0.1', ç«¯å£))
        sock.close()
        return result != 0
    except:
        return True

def å¯åŠ¨ç³»ç»Ÿ():
    """å¯åŠ¨é‚®ä»¶ç³»ç»Ÿ"""
    print("ğŸ¯ å¼€å§‹å¯åŠ¨é‚®ä»¶å¤„ç†ç³»ç»Ÿ...")
    
    # æ£€æŸ¥ä¾èµ–
    if not æ£€æŸ¥ä¾èµ–():
        print("âŒ ç³»ç»Ÿä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•å¯åŠ¨")
        return False
    
    # ç³»ç»Ÿç»„ä»¶åˆ—è¡¨
    # æ³¨æ„ï¼šåªå¯åŠ¨ç»„ä»¶è¿æ¥å™¨ï¼Œé¿å…é‡å¤ç›‘æ§é‚®ä»¶
    ç»„ä»¶åˆ—è¡¨ = [
        ("ç»„ä»¶è¿æ¥å™¨", "component_connector.py", None),
        ("Webåº”ç”¨", "app.py", 5000)
    ]
    
    # å¯åŠ¨ç»„ä»¶
    for ç»„ä»¶å, ç¨‹åºæ–‡ä»¶, ç«¯å£ in ç»„ä»¶åˆ—è¡¨:
        # æ£€æŸ¥ç«¯å£
        if ç«¯å£ and not æ£€æŸ¥ç«¯å£(ç«¯å£):
            print(f"âš ï¸ ç«¯å£ {ç«¯å£} å·²è¢«å ç”¨ï¼Œè·³è¿‡ {ç»„ä»¶å}")
            continue
        
        if not å¯åŠ¨ç»„ä»¶(ç»„ä»¶å, ç¨‹åºæ–‡ä»¶):
            print(f"âŒ {ç»„ä»¶å} å¯åŠ¨å¤±è´¥")
            if ç»„ä»¶å in ["ç»„ä»¶è¿æ¥å™¨", "Webåº”ç”¨"]:
                print("âŒ å¿…éœ€ç»„ä»¶å¯åŠ¨å¤±è´¥ï¼Œç³»ç»Ÿæ— æ³•æ­£å¸¸è¿è¡Œ")
                return False
    
    print("ğŸ‰ é‚®ä»¶ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼")
    print("=" * 60)
    print("ğŸ“‹ å¯åŠ¨çš„ç»„ä»¶ï¼š")
    print("  â€¢ ç»„ä»¶è¿æ¥å™¨ - ç»Ÿä¸€é‚®ä»¶ç›‘æ§ä¸å¤„ç†æ ¸å¿ƒ")
    print("  â€¢ Webåº”ç”¨ - ç”¨æˆ·ç•Œé¢WebæœåŠ¡ (ç«¯å£5000)")
    print("=" * 60)
    print("ğŸŒ è®¿é—®åœ°å€: http://localhost:5000")
    print("ğŸ” ç®¡ç†å‘˜è´¦å·: admin / admin123")
    print("=" * 60)
    print("ğŸ’¡ æç¤ºï¼š")
    print("  â€¢ æ¯ä¸ªç»„ä»¶éƒ½åœ¨ç‹¬ç«‹çš„çª—å£ä¸­è¿è¡Œ")
    print("  â€¢ å…³é—­å¯¹åº”çª—å£å³å¯åœæ­¢è¯¥ç»„ä»¶")
    print("  â€¢ å¦‚éœ€åœæ­¢æ‰€æœ‰ç»„ä»¶ï¼Œè¯·å…³é—­æ‰€æœ‰ç›¸å…³çª—å£")
    print("=" * 60)
    
    return True

def æ˜¾ç¤ºå¸®åŠ©():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    print("ğŸ“– é‚®ä»¶ç³»ç»Ÿç®€å•å¯åŠ¨å™¨ä½¿ç”¨è¯´æ˜")
    print("=" * 60)
    print("åŠŸèƒ½ï¼šå¿«é€Ÿå¯åŠ¨é‚®ä»¶å¤„ç†ç³»ç»Ÿçš„ä¸»è¦ç»„ä»¶")
    print("")
    print("å¯åŠ¨çš„ç»„ä»¶ï¼š")
    print("  â€¢ é‚®ä»¶ç›‘æ§å™¨: QQé‚®ç®±å®æ—¶ç›‘æ§")
    print("  â€¢ ç»„ä»¶è¿æ¥å™¨: é‚®ä»¶å¤„ç†æ ¸å¿ƒç»„ä»¶")
    print("  â€¢ Webåº”ç”¨: ç”¨æˆ·ç•Œé¢WebæœåŠ¡ (ç«¯å£5000)")
    print("  â€¢ è‡ªåŠ¨å¤„ç†å™¨: é‚®ä»¶è‡ªåŠ¨åŒ–å¤„ç†")
    print("")
    print("ä½¿ç”¨æ–¹æ³•ï¼š")
    print("  python ç®€å•å¯åŠ¨.py")
    print("")
    print("ç‰¹ç‚¹ï¼š")
    print("  â€¢ æ¯ä¸ªç»„ä»¶åœ¨ç‹¬ç«‹çª—å£ä¸­è¿è¡Œ")
    print("  â€¢ æ— éœ€å¤æ‚çš„è¿›ç¨‹ç®¡ç†")
    print("  â€¢ ç®€å•æ˜“ç”¨ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨")
    print("=" * 60)

def main():
    """ä¸»å‡½æ•°"""
    # æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°
    if len(sys.argv) > 1 and sys.argv[1] in ['-h', '--help', 'help']:
        æ˜¾ç¤ºå¸®åŠ©()
        return
    
    try:
        # æ˜¾ç¤ºæ ‡é¢˜
        æ‰“å°æ ‡é¢˜()
        
        # å¯åŠ¨ç³»ç»Ÿ
        if å¯åŠ¨ç³»ç»Ÿ():
            print("\nğŸ‰ ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼")
            print("è¯·æŸ¥çœ‹å„ä¸ªç»„ä»¶çš„è¿è¡Œçª—å£ï¼Œç¡®è®¤ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚")
        else:
            print("âŒ ç³»ç»Ÿå¯åŠ¨å¤±è´¥")
            sys.exit(1)
            
    except KeyboardInterrupt:
        print("\nğŸ“¡ ç”¨æˆ·ä¸­æ–­å¯åŠ¨è¿‡ç¨‹")
    except Exception as e:
        print(f"âŒ ç³»ç»Ÿå¯åŠ¨å‡ºé”™: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
