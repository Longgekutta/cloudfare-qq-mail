# è…¾è®¯äº‘ä¸“ç”¨ä¼˜åŒ–ç‰ˆ - æœ€å¿«æ„å»ºé€Ÿåº¦
FROM python:3.9-slim

# è®¾ç½®æ ‡ç­¾ä¿¡æ¯
LABEL maintainer="cloudfare-qq-mail"
LABEL version="1.0.0-tencent"
LABEL description="Cloudfare QQ Mail Service - Tencent Cloud Optimized"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# è…¾è®¯äº‘ä¸“ç”¨é•œåƒæºé…ç½®ï¼ˆå†…ç½‘é«˜é€Ÿï¼‰
RUN rm -rf /etc/apt/sources.list* && \
    mkdir -p /etc/apt/sources.list.d && \
    echo "# è…¾è®¯äº‘å†…ç½‘é•œåƒæº - æœ€é«˜é€Ÿåº¦" > /etc/apt/sources.list && \
    echo "deb http://mirrors.tencentyun.com/debian/ bookworm main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.tencentyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.tencentyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "" >> /etc/apt/sources.list && \
    echo "# å¤‡ç”¨æº1 - è…¾è®¯äº‘å…¬ç½‘é•œåƒ" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.cloud.tencent.com/debian/ bookworm main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.cloud.tencent.com/debian/ bookworm-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.cloud.tencent.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "" >> /etc/apt/sources.list && \
    echo "# å¤‡ç”¨æº2 - é˜¿é‡Œäº‘" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list

# è…¾è®¯äº‘ç½‘ç»œä¼˜åŒ–é…ç½®
RUN echo "# è…¾è®¯äº‘ä¸“ç”¨APTé…ç½®" > /etc/apt/apt.conf.d/99tencent && \
    echo "Acquire::http::Timeout \"8\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "Acquire::https::Timeout \"8\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "Acquire::Retries \"2\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "APT::Get::Assume-Yes \"true\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "APT::Install-Recommends \"false\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "APT::Install-Suggests \"false\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "Acquire::ForceIPv4 \"true\";" >> /etc/apt/apt.conf.d/99tencent && \
    echo "# ä¼˜å…ˆä½¿ç”¨è…¾è®¯äº‘å†…ç½‘" >> /etc/apt/apt.conf.d/99tencent

# æ³¨æ„ï¼šä¸èƒ½åœ¨Dockerfileä¸­ä¿®æ”¹/etc/hostsï¼Œå°†é€šè¿‡sources.listå®Œå…¨æ›¿æ¢æ¥é¿å…å®˜æ–¹æº

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è…¾è®¯äº‘é«˜é€Ÿå®‰è£…ç³»ç»Ÿä¾èµ–
RUN echo "ğŸš€ è…¾è®¯äº‘é«˜é€Ÿå®‰è£…å¼€å§‹..." && \
    apt-get clean && \
    apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends --fix-missing \
        gcc \
        default-libmysqlclient-dev \
        pkg-config \
        curl \
        default-mysql-client \
        wget \
        unzip \
        ca-certificates \
        build-essential \
        python3-dev && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean && \
    echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

# è…¾è®¯äº‘PyPIé•œåƒæºé…ç½®ï¼ˆè…¾è®¯äº‘å†…ç½‘æœ€å¿«ï¼‰
RUN pip config set global.index-url https://mirrors.cloud.tencent.com/pypi/simple/ && \
    pip config set global.trusted-host mirrors.cloud.tencent.com && \
    pip config set global.extra-index-url "https://pypi.tuna.tsinghua.edu.cn/simple/ https://mirrors.aliyun.com/pypi/simple/" && \
    pip config set global.timeout 20

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# è…¾è®¯äº‘é«˜é€Ÿå®‰è£…Pythonä¾èµ–
RUN echo "ğŸš€ è…¾è®¯äº‘é«˜é€ŸPythonåŒ…å®‰è£…..." && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

# å¤åˆ¶åº”ç”¨æ–‡ä»¶ï¼ˆåˆ†å±‚ä¼˜åŒ–ï¼‰
COPY app.py config.py ./
COPY *.py ./
COPY database/ ./database/
COPY frontend/ ./frontend/
COPY nginx/ ./nginx/

# å¤åˆ¶è„šæœ¬å’Œé…ç½®
COPY *.sh ./
COPY *.bat ./
COPY docker-compose*.yml ./
COPY .env.production ./.env

# åˆ›å»ºç›®å½•å’Œè®¾ç½®æƒé™
RUN mkdir -p /app/uploads /app/temp_attachments /app/received_emails /app/sent_attachments /app/logs /app/database/backup && \
    chmod 755 /app/uploads /app/temp_attachments /app/received_emails /app/sent_attachments /app/logs /app/database/backup && \
    chmod +x /app/docker-init.sh && \
    chmod +x /app/*.sh 2>/dev/null || true

# è…¾è®¯äº‘éƒ¨ç½²éªŒè¯
RUN echo "=== è…¾è®¯äº‘éƒ¨ç½²éªŒè¯ ===" && \
    python --version && \
    pip --version && \
    mysql --version && \
    curl --version && \
    echo "âœ… éªŒè¯é€šè¿‡" && \
    ls -la /app/ && \
    echo "ğŸ‰ è…¾è®¯äº‘ä¸“ç”¨ç‰ˆæ„å»ºå®Œæˆ - é¢„è®¡æ„å»ºæ—¶é—´ 1-3 åˆ†é’Ÿ"

# è®¾ç½®æ–‡ä»¶æ‰€æœ‰æƒ
RUN chown -R appuser:appuser /app

# æš´éœ²ç«¯å£
EXPOSE 5000

# åˆ‡æ¢ç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/ || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["bash", "/app/docker-init.sh"]
